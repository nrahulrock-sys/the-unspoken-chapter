
/**
 * THE CINEMATIC ENGINE v2.0
 * Handcrafted Digital Experience Manager
 */

const CONFIG = {
    bgmUrl: "public/audio/Finding Her (Jana Mere Sawalon Ka Manzar Tu)  Kushagra  Vanshika  Bharath  Karan Maini UR Debut - UR DEBUT.mp3",
    voiceUrl: "public/audio/Dean Lewis - Memories (Official Video) - DeanLewisVEVO.mp3",
    memories: [
        {
            img: "/college/Untitled%20design.jpeg",
            text: "Where the world first started to feel different."
        },

        {
            img: "public/college/Untitled design (1).jpeg",
            text: "In a few quiet moments shared with you, I found where I belong."
        },
        {
            img: "public/college/Untitled design (2).jpeg",
            text: "Counting moments, not hours."
        },
        {
            img: "public/college/Untitled design (3).jpeg",
            text: "Every evening meeting was just a masterpiece with you."
        },
        {
            img: "public/college/Untitled design (4).jpeg",
            text: "For the thousands of steps were you stood by me "
        }
    ],
    finalLetter: {
        header: "letter",
        paragraphs: [
            "From,  Once yours ",
            "To,  Always mine",

            "I don’t know how to begin this without sounding like I’m holding on, so I’ll start with honesty instead.",
            "Thank you for existing from the moment i saw you.",

            "To be honest Sri, you didn't just love me, you built me. Nuvvu first day ninnu kopam tho chusina Rahul gaadu veru ippudu ila neekosam letter rasthunna Rahul gaadu veru. Valla iddhariki polikalallo thappithey inka endhuloo compare cheyyataniki same levu.",
            "I've changed alot because of you. Eppudu serious ga, ontari ga, immatured ga, irresponsible ga undey vaadini. Nuvvu naa life lo rakapoina maarevadini emo ila kaani chala time pattedhi emo you were like a catalyst in my story.",
            "Naku asalu nachanidhey patience okari kosam wait cheyyatam anna ledha dhenikosam aina vethakatam lo ayinaa assalu opika undedhi kaadhu kaani nuvvu coaching vellinappudu naa clg 4 ke ayipoyedhi appati nunchi 8 varaku mbl lekunda just ala velley prathi bus lo srivani e lo bus untadhi emo e bus lo untadhi emo ani chusthu manchi cars em ochai ani lekkeskuntu wait cheseyvadini eppudu wait chesthunnanu nee kosam anna feel ochedhi kaadhu malli chudu ippudu eppudo jan 14th na anukuntaa nuvvu \"let's move on its not gonna happen anymore\" ani idhey words msg chesav its almost been an year now chudu im still hangin  on and i'll just asking you lets be normal just the we used to be. see chala change ayyanu kadha. I felt proud of me.",
            "Asalu verey valla intlo food eppudu nachedhi kaadhu vomit cheskuney vaadini mee intlo  appudu osari ni birthday roju thinna aa kodhiga food ni vomit avvakunda control cheskunnanu. Naaku aaroju endhuku ila unnanu nenu love chesina ammai valla intlo kuda kaneesam undalekapothunanu anukunevadini kaani last time nee birthday ki ochanu chusavaa mee amma kavalaney em thinatledhu antundhi kaani chala thinnanu nenu a point lo kuda food ekkuva esesaru thinakapothey feel avtharu kukkukovali vomit aapukovali anna feel okksari kuda raaledhu. I felt like damn man i changed alot, haa for you it might sound cringe but for me naa lopala unna aa patha Rahul gaadu entha proud ga feel ayyadu antey he literally said fuck bro you made it.",
            "Eppudoo edho vishayam lo ninnu thittesanu gattiga. That was the last time nenu nee paina kopadindhi, appati nundi nen ninnu a vishaym lo koppadi edhi padithey adhi vageyledhu adhi nee vishaymlo loney kaadhu naaku chala sarlu use ayyindhi adhi kopam ochina prathi sari ela padithey ala vageykunda oka 10sec aalochinchi nenu matladuthindhi correct a naa ani tharvtha edhina aney vadini, all credit goes to you haha",
            "Ila nenu change avvatam valla nuvvu naaku inka close avthavu aney process lo chala ekkuvaga love chesesanu sri ninnu, andhukey i wrote a quote which says \"If all my love were spoken I couldn't tell you half\" ani I wrote this knowing that my love is not the kind that is glorified or romanticized not as much as popular as Romeo and Juliet, Mumtaz and Shah Jahan, Ram and Sita or Radha and Krishna. But I knew my love would be long lasting one of those rare kinds that stays forever the kind of love where i could spend my entire life just telling you how much i love you every time you ask hahaha",
            "neeku thelikundaney chala chesav sri nuvvu naakosam chala antey chalaa that i could spend my entire life thanking you ",
            "neney asalu em cheyyaledhu nen neeku chesina promises lo edhi nilapettukoledhu kaani okkati marthram chala nelapettkuntunanu anipisthundhi em promise aa ani aalochisthunnavaa adhey \"that i love you no matter what \" this give me hope nenu brake chesina prathi promise prove cheskovali ani gurthu chestha untadhi melli melliga prathi okati chesthanu anna nammakam osthadhi naaku ",
            "nenu neekosam intha chesthunnanu antha chesthunnanu ledha idhi ichanu adhi ichanu ani cheppi ninnu kuda ala naa kosam cheyyali ani eppudu cheppaledhu endhukantey naaku thelsu that i havent done anything ani kaani nuvvu naa kosam chalaa chesav sri, nuvvu naatho andharikantey ekkuva close ga untavu anoo ledha andham ga untavu anoo ledha nuvv naa pakka untey better avthanu neney chala change avvochu naakey benefit avthundhi kadha anna selfishness tho ninnu love cheyyaledhu sri",
            "I never loved you for your touch, I never loved you for your hug, I never loved you for your kiss, and I never loved you to leave you.",
            "I loved you because of your presence, Its the only thing i turly wanted from you.",
            "Nuvv naa life lo ki vachaka chala happy ga feel ayyanu sri. Yeah i was happy before you but i was happier with you i dont know why but i always wanted to hide my feelings i always tried to portrey myself as a brave boy, hardworking, smart and good but with you i was being honest with myself and somehow i love myself even more when im with you.",
            "kaani last year after your words \"naa la nenu undatam nachatledhu neeku\" it hurts like hell because i had always told you that to be you as you wanted kaani aa okka sentence nenu neetho undey vidhananni marchesindhi sri, from that moment i stopped being honest with myself i became hesitant to tell you how afraid i was - afraid even of the breeze that touched my woman. Neetho prathi vishayam share cheskotam enjoy chesey nenu edhi cheppina em aalochisthavoo ani overcautious ga undevadini, I was scared you might that, what happend to him all of a sudden? why did he become possessive? why doesnt he want me to be the way i want to be ? ",
            "But you know what - of course i wanted you to be independent. i wanted you to have your own life to make your own decisions, to grow into who you wanted to be.",
            "I just never wanted an independence that made it possible for you to live wihtout me",
            "Yes accept chesthanu sri nee decision ni endhukantey just because a decision hurts me that doesnt mean its wrong kadha its all about perspectives isn't ?",
            "nenu ninnu kaani nee aalochanlanu ni kaani ee society ni kaani ledha nee parents no naa parents blame cheyyali ani ledhu i want to blame myself for being the way i was and iam and im sorry intha kantey veredhi edhi ledhu naa dhaggara cheppataniki.",
            "naa last year neetho start ayyindhi you said we gonna blast this i think you did what you said kaani neney instead of blasting i was busted hahahaha.",
            "Nuvvey correct sri neney wrong mana vishaym lo prathi dhantlo neney worng nuvvu ivi anni em aalochinchaku you got a job jan lo eppudo join annavu i want to give you suggestion dhenni suggestion anukuntavoo ledha restrictions anukuntavoo follow avthavoo ledho nee istam last time restrict cheyyanandhuku matalu annavu maha ayithey ippudu chesthunnadhu antavu emo nee istam kaani make boundaries sri do things which will never make you regret in your life forget about past and future, present lo undu kastha happy ga rich gaa malli last time laga e year kuda blast chesi padey",
            "E letter rasthundhi endhukantey just to say thank you thank you for chaning me and thank you for everything. ",
            "haaa oka game adadhamaa nenu kindha konni words mention chesthanu neeku aa sec ki em alochana osthey adhi mansulo anukoo kinda cring game i know okasari try cheyy ",
            "1. parents",
            "2. bunny",
            "3.chinnu",
            "4. school",
            "5. friends",
            "6. diploma",
            "7. ecet",
            "8. college",
            "9. future",
            "",
            "",
            "10. Rahul",
            "anthey game ayipoyindhi",
            " Thanks for bearing with me ",
            "and Thanks",
            "For the moments that didnt need words. For the days that felt peaceful just because you were there. For being a part of my life in a way that changed me for the better.",
            "What we shared was real — at least to me, and I dont want to reduce it to memories that fade quietly. Some things deserve to be acknowledged even when they forced to end.",
            "I wont pretend I didnt wish for more time. But Ive learned that care doesnt always mean staying — sometimes it means letting go without turning love into a burden.",
            "Wherever life takes you from here, I hope you find peace, excitement,joyfull and someone who understands you in all the ways you deserve.",
            "As for me, Ill carry what was good, learn from what wasnt, and be grateful for what existed — even briefly.",
            "This is not a goodbye filled with regret. It’s one filled with respect.",
            "Thank you for being you. Thank you for the memories.",
            "I wish you a beautiful year ahead and a beautiful life beyond this moment.",
            "Remember the date 02-11-2030 appati varaku naa nunchi elanti disturbance undadhu neeku, ninnu appati varaku wait cheyyamani cheppatledhu in the meanwhile be how ever you want kaani aaroju nenu anukundhi chesthunnanu i can hope for a better future ani nannu nenu prove cheskuntey ne vasthanu just to say that i loved you, i've been loving you and ill love you ",
            "Love you Infinite sri",
            "Bye."
        ]
    }
};

class CinematicApp {
    private currentScene = 0;
    private audioStarted = false;
    private bgm = new Audio(CONFIG.bgmUrl);
    private voice = new Audio(CONFIG.voiceUrl);
    private container = document.getElementById('experience')!;
    private isTransitioning = false;

    constructor() {
        this.bgm.loop = true;
        this.bgm.volume = 0;

        // Preload imagery
        CONFIG.memories.forEach(m => {
            const img = new Image();
            img.src = m.img;
        });

        this.voice.addEventListener('ended', () => {
            const blackout = document.getElementById('final-blackout');
            if (blackout) blackout.classList.add('active');
        });
    }

    public async next() {
        if (this.isTransitioning) return;
        this.isTransitioning = true;

        if (!this.audioStarted) {
            this.startAudio();
            this.audioStarted = true;
        }

        this.currentScene++;
        const totalScenes = CONFIG.memories.length + 2;

        if (this.currentScene > totalScenes - 1) return;

        // Visual fade out
        const active = this.container.querySelector('.content-layer');
        if (active) {
            active.classList.remove('active');
            await new Promise(r => setTimeout(r, 2000));
        }

        this.container.innerHTML = '';

        if (this.currentScene <= CONFIG.memories.length) {
            this.renderMemory(this.currentScene - 1);
        } else {
            this.renderFinal();
            this.transitionAudio();
        }

        requestAnimationFrame(() => {
            const next = this.container.querySelector('.content-layer');
            next?.classList.add('active');
            this.isTransitioning = false;
        });

        // Hide navigation cue on the final screen
        const cue = document.querySelector('.cue') as HTMLElement;
        if (this.currentScene === totalScenes - 1) {
            if (cue) cue.style.opacity = '0';
            setTimeout(() => { if (cue) cue.style.display = 'none'; }, 2000);
        } else {
            if (cue) cue.innerText = "Continue the past";
        }
    }

    private renderMemory(index: number) {
        const memory = CONFIG.memories[index];
        this.container.innerHTML = `
            <div class="content-layer">
                <img src="${memory.img}" class="scene-image" alt="">
                <p class="caption">${memory.text}</p>
            </div>
        `;
    }

    private renderFinal() {
        const letter = CONFIG.finalLetter;
        const paragraphsHtml = letter.paragraphs.map((p, i) =>
            `<p class="letter-para" style="animation-delay: ${i * 1.5 + 2}s">${p}</p>`
        ).join('');

        this.container.innerHTML = `
            <div class="content-layer final-letter-container">
                <p class="handwritten" style="animation: slowFadeIn 3s forwards;">${letter.header}</p>
                <div class="letter-body">
                    ${paragraphsHtml}
                </div>
            </div>
        `;
    }

    private startAudio() {
        this.bgm.play().catch(e => console.error("Audio blocked:", e));
        this.fadeAudio(this.bgm, 0, 0.3, 4000);
    }

    private transitionAudio() {
        this.fadeAudio(this.bgm, this.bgm.volume, 0, 5000).then(() => {
            this.bgm.pause();
            this.voice.volume = 0;
            this.voice.play().catch(e => console.error("Voice blocked:", e));
            this.fadeAudio(this.voice, 0, 1, 3000);
        });
    }

    private fadeAudio(audio: HTMLAudioElement, from: number, to: number, duration: number) {
        return new Promise<void>(resolve => {
            const start = performance.now();
            const step = (now: number) => {
                // Ensure progress is clamped within [0, 1]
                const progress = Math.max(0, Math.min((now - start) / duration, 1));
                const eased = 1 - Math.pow(1 - progress, 3); // OutCubic easing
                const volume = from + (to - from) * eased;

                // Explicitly clamp the final volume value to [0, 1] to avoid IndexSizeError
                audio.volume = Math.max(0, Math.min(1, volume));

                if (progress < 1) {
                    requestAnimationFrame(step);
                } else {
                    resolve();
                }
            };
            requestAnimationFrame(step);
        });
    }
}

(window as any).app = new CinematicApp();
